/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";function MasterPasswordController($scope,$routeParams,$location,keepass,localStorage,unlockedState,secureCache,settings,optionsLink){function showResults(entries,streamKey){var siteUrl=parseUrl(unlockedState.url),siteTokens=getValidTokens(siteUrl.hostname+"."+unlockedState.title);entries.forEach(function(entry){var entryHostName=parseUrl(entry.url).hostname||"";entry.matchRank=entryHostName&&entryHostName==siteUrl.hostname?100:0,entry.matchRank+=entry.title&&unlockedState.title&&entry.title.toLowerCase()==unlockedState.title.toLowerCase()?1:0,entry.matchRank+=entry.title&&entry.title.toLowerCase()===siteUrl.hostname.toLowerCase()?1:0,entry.matchRank+=entry.url&&siteUrl.hostname.indexOf(entry.url.toLowerCase())>-1?.9:0,entry.matchRank+=entry.title&&siteUrl.hostname.indexOf(entry.title.toLowerCase())>-1?.9:0;for(var entryTokens=getValidTokens(entryHostName+"."+entry.title),i=0;i<entryTokens.length;i++)for(var token1=entryTokens[i],j=0;j<siteTokens.length;j++){var token2=siteTokens[j];entry.matchRank+=token1===token2?.2:0}}),unlockedState.entries=entries.filter(function(entry){return entry.matchRank>=100}),0==unlockedState.entries.length&&(unlockedState.entries=entries.filter(function(entry){return entry.matchRank>.8&&!entry.URL})),0==unlockedState.entries.length&&(unlockedState.entries=entries.filter(function(entry){return entry.matchRank>=.4}),unlockedState.entries.length&&($scope.partialMatchMessage="No close matches, showing "+unlockedState.entries.length+" partial matches.")),0==unlockedState.entries.length&&($scope.errorMessage="No matches found for this site."),unlockedState.streamKey=streamKey,secureCache.save("entries",entries),secureCache.save("streamKey",streamKey)}function getValidTokens(tokenString){return tokenString?tokenString.toLowerCase().split(/\.|\s|\//).filter(function(token){return token&&"com"!==token&&"www"!==token&&token.length>1}):[]}function parseUrl(url){url&&0==!url.indexOf("http")&&(url="http://"+url);var parser=document.createElement("a");return parser.href=url,parser}$scope.masterPassword="",$scope.busy=!1,$scope.fileName=decodeURIComponent($routeParams.fileTitle),$scope.providerKey=$routeParams.providerKey,$scope.selectedKeyFile=null,$scope.unlockedState=unlockedState,$scope.os={},chrome.runtime.getPlatformInfo(function(info){$scope.$apply(function(){$scope.os[info.os]=!0})}),settings.getKeyFiles().then(function(keyFiles){$scope.keyFiles=keyFiles}).then(function(){return localStorage.getCurrentDatabaseUsage()}).then(function(usage){if($scope.hidePassword=usage.requiresPassword===!1,$scope.hideKeyFile=usage.requiresKeyfile===!1,usage.keyFileName){var matches=$scope.keyFiles.filter(function(keyFile){return keyFile.name==usage.keyFileName});matches.length&&($scope.selectedKeyFile=matches[0])}$scope.hidePassword&&$scope.selectedKeyFile&&$scope.enterMasterPassword()}).then(function(){$scope.$apply()}),unlockedState.getTabDetails().then(function(){$scope.$apply()}),secureCache.get("entries").then(function(entries){return entries&&entries.length?secureCache.get("streamKey").then(function(streamKey){showResults(entries,streamKey),$scope.$apply()}):void 0})["catch"](function(){secureCache.clear("entries"),secureCache.clear("streamKey")}),$scope.manageKeyFiles=function(){optionsLink.go()},$scope.chooseAnotherFile=function(){unlockedState.clearBackgroundState(),secureCache.clear("entries"),secureCache.clear("streamKey"),$location.path("/choose-file")},$scope.enterMasterPassword=function(){$scope.clearMessages(),$scope.busy=!0,keepass.getPasswords($scope.masterPassword,$scope.selectedKeyFile).then(function(entries){localStorage.saveCurrentDatabaseUsage({requiresPassword:$scope.masterPassword?!0:!1,requiresKeyfile:$scope.selectedKeyFile?!0:!1,keyFileName:$scope.selectedKeyFile?$scope.selectedKeyFile.name:""}),showResults(entries,keepass.streamKey),$scope.busy=!1})["catch"](function(err){$scope.errorMessage=err.message||"Incorrect password or key file",$scope.busy=!1}).then(function(){$scope.$apply()})},$scope.findManually=function(){$location.path("/find-entry")},$scope.clearMessages=function(){$scope.errorMessage="",$scope.successMessage="",$scope.partialMatchMessage=""}}