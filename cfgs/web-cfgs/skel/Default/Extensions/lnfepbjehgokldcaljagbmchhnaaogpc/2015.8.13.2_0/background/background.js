/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";!function(protectedMemory,settings){function doReplaceRules(){chrome.declarativeContent.onPageChanged.removeRules(void 0,function(){var passwordField={id:"pwdField",conditions:[new chrome.declarativeContent.PageStateMatcher({css:["input[type='password']"]})],actions:[new chrome.declarativeContent.ShowPageAction]},textField={id:"textField",conditions:[new chrome.declarativeContent.PageStateMatcher({css:["input[type='text'], input[type='email'], input:not([type])"]})],actions:[new chrome.declarativeContent.ShowPageAction]},iframeLogin={id:"iframeLogin",conditions:[new chrome.declarativeContent.PageStateMatcher({css:["iframe[src^='https']"]})],actions:[new chrome.declarativeContent.ShowPageAction]};chrome.declarativeContent.onPageChanged.addRules([passwordField,textField,iframeLogin])})}function handleMessage(message,sender,sendResponse){message&&message.m&&("requestPermission"==message.m&&chrome.permissions.contains(message.perms,function(alreadyGranted){chrome.runtime.lastError||alreadyGranted&&message.then?handleMessage(message.then,sender,sendResponse):chrome.permissions.request(message.perms,function(granted){granted&&message.then&&handleMessage(message.then,sender,sendResponse)})}),"autofill"==message.m&&chrome.tabs.executeScript(message.tabId,{file:"keepass.js",allFrames:!0},function(){chrome.tabs.sendMessage(message.tabId,{m:"fillPassword",u:message.u,p:message.p,o:message.o})}))}chrome.extension.inIncognitoContext?doReplaceRules():(chrome.runtime.onInstalled.addListener(doReplaceRules),chrome.runtime.onInstalled.addListener(settings.upgrade)),chrome.runtime.onConnect.addListener(function(port){port.onMessage.addListener(function(msg){if(msg)switch(msg.action){case"clear":protectedMemory.clearData();break;case"save":protectedMemory.setData(msg.key,msg.value);break;case"get":protectedMemory.getData(msg.key).then(function(value){port.postMessage(value)});break;default:throw new Error("unrecognized action "+obj.action)}}),port.onDisconnect.addListener(function(){})}),chrome.runtime.onMessage.addListener(handleMessage),chrome.alarms.onAlarm.addListener(function(alarm){if("clearClipboard"==alarm.name){var clearClipboard=function(e){e.clipboardData.setData("text/plain",""),e.preventDefault(),document.removeEventListener("copy",clearClipboard)};document.addEventListener("copy",clearClipboard),document.execCommand("copy")}})}(new ProtectedMemory,new Settings);