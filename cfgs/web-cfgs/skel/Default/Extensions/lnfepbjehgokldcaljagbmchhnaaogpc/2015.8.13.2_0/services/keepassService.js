/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";function Keepass(keepassHeader,pako,settings,passwordFileStoreRegistry){function getKey(h,masterPassword,fileKey){var partPromises=[],SHA={name:"SHA-256"};if(masterPassword||!fileKey){var encoder=new TextEncoder,masterKey=encoder.encode(masterPassword),p=window.crypto.subtle.digest(SHA,new Uint8Array(masterKey));partPromises.push(p)}return fileKey&&partPromises.push(Promise.resolve(fileKey)),Promise.all(partPromises).then(function(parts){if(h.kdbx||partPromises.length>1){for(var compositeKeySource=new Uint8Array(32*parts.length),i=0;i<parts.length;i++)compositeKeySource.set(new Uint8Array(parts[i]),32*i);return window.crypto.subtle.digest(SHA,compositeKeySource)}return partPromises[0]})}function parseKdb(buf,h){return window.crypto.subtle.digest({name:"SHA-256"},h.protectedStreamKey).then(function(streamKey){my.streamKey=streamKey;for(var iv=[232,48,9,75,151,32,93,42],salsa=new Salsa20(new Uint8Array(my.streamKey),iv),salsaPosition=0,pos=0,dv=new DataView(buf),groups=[],i=0;i<h.numberOfGroups;i++){for(var fieldType=0,fieldSize=0,currentGroup={},preventInfinite=100;65535!=fieldType&&preventInfinite>0;)fieldType=dv.getUint16(pos,littleEndian),fieldSize=dv.getUint32(pos+2,littleEndian),pos+=6,readGroupField(fieldType,fieldSize,buf,pos,currentGroup),pos+=fieldSize,preventInfinite-=1;groups.push(currentGroup)}for(var entries=[],i=0;i<h.numberOfEntries;i++){for(var fieldType=0,fieldSize=0,currentEntry={keys:[]},preventInfinite=100;65535!=fieldType&&preventInfinite>0;)fieldType=dv.getUint16(pos,littleEndian),fieldSize=dv.getUint32(pos+2,littleEndian),pos+=6,readEntryField(fieldType,fieldSize,buf,pos,currentEntry),pos+=fieldSize,preventInfinite-=1;if(currentEntry.group=groups.filter(function(grp){return grp.id==currentEntry.groupId})[0],currentEntry.groupName=currentEntry.group.name,currentEntry.password){var encoder=new TextEncoder,passwordBytes=encoder.encode(currentEntry.password),encPassword=salsa.encrypt(new Uint8Array(passwordBytes));currentEntry.protectedData={password:{data:encPassword,position:salsaPosition}},currentEntry.password=Base64.encode(encPassword),salsaPosition+=passwordBytes.byteLength}"Meta-Info"==currentEntry.title&&"SYSTEM"==currentEntry.userName||"Backup"==currentEntry.groupName||"Search Results"==currentEntry.groupName||entries.push(currentEntry)}return entries})}function readEntryField(fieldType,fieldSize,buf,pos,entry){var dv=new DataView(buf,pos,fieldSize),arr=[];fieldSize>0&&(arr=new Uint8Array(buf,pos,fieldSize-1));var decoder=new TextDecoder;switch(fieldType){case 0:break;case 1:entry.id=convertArrayToUUID(new Uint8Array(buf,pos,fieldSize));break;case 2:entry.groupId=dv.getUint32(0,littleEndian);break;case 3:entry.iconId=dv.getUint32(0,littleEndian);break;case 4:entry.title=decoder.decode(arr),entry.keys.push("title");break;case 5:entry.url=decoder.decode(arr),entry.keys.push("url");break;case 6:entry.userName=decoder.decode(arr),entry.keys.push("userName");break;case 7:entry.password=decoder.decode(arr);break;case 8:entry.notes=decoder.decode(arr),entry.keys.push("notes")}}function readGroupField(fieldType,fieldSize,buf,pos,group){var dv=new DataView(buf,pos,fieldSize),arr=[];switch(fieldSize>0&&(arr=new Uint8Array(buf,pos,fieldSize-1)),fieldType){case 0:break;case 1:group.id=dv.getUint32(0,littleEndian);break;case 2:var decoder=new TextDecoder;group.name=decoder.decode(arr)}}function getDecryptedEntry(protectedData,streamKey){if(void 0===protectedData)return"";var iv=[232,48,9,75,151,32,93,42],salsa=new Salsa20(new Uint8Array(streamKey||my.streamKey),iv),decoder=new TextDecoder;salsa.getBytes(protectedData.position);var decryptedBytes=new Uint8Array(salsa.decrypt(protectedData.data));return decoder.decode(decryptedBytes)}function parseXml(xml,protectedStreamKey){return window.crypto.subtle.digest({name:"SHA-256"},protectedStreamKey).then(function(streamKey){my.streamKey=streamKey;for(var parser=(new TextDecoder,new DOMParser),doc=parser.parseFromString(xml,"text/xml"),results=[],entryNodes=doc.evaluate("//Entry",doc,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null),protectedPosition=0,i=0;i<entryNodes.snapshotLength;i++){var entryNode=entryNodes.snapshotItem(i),entry={protectedData:{},keys:[]};if("History"!=entryNode.parentNode.nodeName){for(var m=0;m<entryNode.parentNode.children.length;m++){var groupNode=entryNode.parentNode.children[m];"Name"==groupNode.nodeName&&(entry.groupName=groupNode.textContent)}"Recycle Bin"!=entry.groupName&&results.push(entry)}for(var j=0;j<entryNode.children.length;j++){var childNode=entryNode.children[j];if("UUID"==childNode.nodeName)entry.id=convertArrayToUUID(Base64.decode(childNode.textContent));else if("IconID"==childNode.nodeName)entry.iconId=Number(childNode.textContent);else if("Tags"==childNode.nodeName&&childNode.textContent)entry.tags=childNode.textContent,entry.keys.push("tags");else if("Binary"==childNode.nodeName)entry.binaryFiles=childNode.textContent,entry.keys.push("binaryFiles");else if("String"==childNode.nodeName){var key=childNode.getElementsByTagName("Key")[0].textContent;key=Case.camel(key);var valNode=childNode.getElementsByTagName("Value")[0],val=valNode.textContent,protectedVal=valNode.hasAttribute("Protected");if(protectedVal){var encBytes=new Uint8Array(Base64.decode(val));entry.protectedData[key]={position:protectedPosition,data:encBytes},protectedPosition+=encBytes.length}else entry.keys.push(key);entry[key]=val}}}return results})}function aes_ecb_encrypt(rawKey,data,rounds){for(var data=new Uint8Array(data),blockCount=data.byteLength/16,blockPromises=new Array(blockCount),i=0;blockCount>i;i++){var block=data.subarray(16*i,16*i+16);blockPromises[i]=function(iv){return aes_cbc_rounds(iv,rawKey,rounds)}(block)}return Promise.all(blockPromises).then(function(blocks){for(var result=new Uint8Array(data.byteLength),i=0;blockCount>i;i++)result.set(blocks[i],16*i);return result})}function aes_cbc_rounds(data,rawKey,rounds){return 0==rounds?data:rounds>65535?aes_cbc_rounds_single(data,rawKey,65535).then(function(result){return aes_cbc_rounds(result,rawKey,rounds-65535)}):aes_cbc_rounds_single(data,rawKey,rounds)}function aes_cbc_rounds_single(data,rawKey,rounds){var AES={name:"AES-CBC",iv:data};return window.crypto.subtle.importKey("raw",rawKey,AES,!1,["encrypt"]).then(function(secureKey){var fakeData=new Uint8Array(16*rounds);return window.crypto.subtle.encrypt(AES,secureKey,fakeData)}).then(function(result){return new Uint8Array(result,16*(rounds-1),16)})}function convertArrayToUUID(arr){for(var int8Arr=new Uint8Array(arr),result=new Array(2*int8Arr.byteLength),i=0;i<int8Arr.byteLength;i++)result[2*i]=int8Arr[i].toString(16).toUpperCase();return result.join("")}var my={},littleEndian=function(){var buffer=new ArrayBuffer(2);return new DataView(buffer).setInt16(0,256,!0),256===new Int16Array(buffer)[0]}();return my.getPasswords=function(masterPassword,keyFileInfo){var fileKey=keyFileInfo?Base64.decode(keyFileInfo.encodedKey):null;return passwordFileStoreRegistry.getChosenDatabaseFile(settings).then(function(buf){var h=keepassHeader.readHeader(buf);if(!h)throw new Error("Failed to read file header");if(2!=h.innerRandomStreamId&&0!=h.innerRandomStreamId)throw new Error("Invalid Stream Key - Salsa20 is supported by this implementation, Arc4 and others not implemented.");var encData=new Uint8Array(buf,h.dataStart),SHA={name:"SHA-256"},AES={name:"AES-CBC",iv:h.iv},compositeKeyPromise=getKey(h,masterPassword,fileKey);return compositeKeyPromise.then(function(masterKey){return aes_ecb_encrypt(h.transformSeed,masterKey,h.keyRounds)}).then(function(finalVal){return window.crypto.subtle.digest({name:"SHA-256"},finalVal)}).then(function(encMasterKey){var finalKeySource=new Uint8Array(h.masterSeed.byteLength+32);return finalKeySource.set(h.masterSeed),finalKeySource.set(new Uint8Array(encMasterKey),h.masterSeed.byteLength),window.crypto.subtle.digest(SHA,finalKeySource)}).then(function(finalKeyBeforeImport){return window.crypto.subtle.importKey("raw",finalKeyBeforeImport,AES,!1,["decrypt"])}).then(function(finalKey){return window.crypto.subtle.decrypt(AES,finalKey,encData)}).then(function(decryptedData){if(h.kdbx){for(var storedStartBytes=new Uint8Array(decryptedData,0,32),i=0;32>i;i++)if(storedStartBytes[i]!=h.streamStartBytes[i])throw new Error("Decryption succeeded but payload corrupt");for(var done=!1,pos=32,blockArray=[],totalDataLength=0;!done;){{var blockHeader=new DataView(decryptedData,pos,40),blockSize=(blockHeader.getUint32(0,littleEndian),blockHeader.getUint32(36,littleEndian));new Uint8Array(decryptedData,pos+4,32)}if(blockSize>0){var block=new Uint8Array(decryptedData,pos+40,blockSize);blockArray.push(block),totalDataLength+=blockSize,pos+=blockSize+40}else done=!0}var allBlocks=new Uint8Array(totalDataLength);pos=0;for(var i=0;i<blockArray.length;i++)allBlocks.set(blockArray[i],pos),pos+=blockArray[i].byteLength;1==h.compressionFlags&&(allBlocks=pako.inflate(allBlocks));var decoder=new TextDecoder,xml=decoder.decode(allBlocks),entries=parseXml(xml,h.protectedStreamKey);return entries}var entries=parseKdb(decryptedData,h);return entries})})},my.getDecryptedEntry=getDecryptedEntry,my}