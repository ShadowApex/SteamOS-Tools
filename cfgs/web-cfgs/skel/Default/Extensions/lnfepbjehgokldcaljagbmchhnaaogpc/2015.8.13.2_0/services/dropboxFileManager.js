/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";function DropboxFileManager($http,settings){function listDatabasesSafe(){return settings.getDropboxToken().then(function(stored_token){return stored_token?listDatabases():[]})}function login(){return listDatabases()}function logout(){return settings.saveDropboxToken(null).then(function(){state.loggedIn=!1})}function listDatabases(){return getToken().then(function(accessToken){var req={method:"GET",url:"https://api.dropbox.com/1/search/auto/",params:{query:".kdb"},headers:{Authorization:"Bearer "+accessToken}};return $http(req)}).then(function(response){return response.data.map(function(fileInfo){return{title:fileInfo.path}})})["catch"](function(response){return 401==response.status?interactiveLogin().then(listDatabases):void 0})}function getDatabaseChoiceData(dbInfo){return{title:dbInfo.title}}function getChosenDatabaseFile(dbInfo){return getToken().then(function(accessToken){return $http({method:"GET",url:"https://api-content.dropbox.com/1/files/auto"+dbInfo.title,responseType:"arraybuffer",headers:{Authorization:"Bearer "+accessToken}})}).then(function(response){return response.data})["catch"](function(response){return 401==response.status?interactiveLogin().then(function(){return getChosenDatabaseFile(dbInfo)}):void 0})}function ensureOriginPermissions(){var dropboxOrigins=["https://*.dropbox.com/"];return chrome.p.permissions.contains({origins:dropboxOrigins}).then(function(){return!0})["catch"](function(){return chrome.p.permissions.request({origins:dropboxOrigins}).then(function(){return!0})["catch"](function(){return!1})})}function getToken(){return settings.getDropboxToken().then(function(stored_token){return stored_token?(state.loggedIn=!0,stored_token):interactiveLogin().then(function(new_token){return new_token})})}function interactiveLogin(){return ensureOriginPermissions().then(function(){return new Promise(function(resolve,reject){var randomState=Base64.encode(window.crypto.getRandomValues(new Uint8Array(16))),authUrl="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id=6kxu9nd18t4g74m&state="+encodeURIComponent(randomState)+"&redirect_uri="+encodeURIComponent(chrome.identity.getRedirectURL("dropbox"))+"&force_reapprove=false";chrome.p.identity.launchWebAuthFlow({url:authUrl,interactive:!0}).then(function(redirect_url){var tokenMatches=/access_token=([^&]+)/.exec(redirect_url),stateMatches=/state=([^&]+)/.exec(redirect_url),uidMatches=/uid=(\d+)/.exec(redirect_url);if(tokenMatches&&stateMatches&&uidMatches){{var access_token=tokenMatches[1],checkState=decodeURIComponent(decodeURIComponent(stateMatches[1]));uidMatches[1]}checkState===randomState?(state.loggedIn=!0,settings.saveDropboxToken(access_token).then(function(){resolve(access_token)})):(reject(),console.log(redirect_url))}else reject(),console.log(redirect_url)})["catch"](function(err){reject(err)})})})}var state={loggedIn:!1},exports={key:"dropbox",routePath:"/dropbox",listDatabases:listDatabasesSafe,getDatabaseChoiceData:getDatabaseChoiceData,getChosenDatabaseFile:getChosenDatabaseFile,supportedFeatures:["ingognito","listDatabases"],title:"Dropbox",icon:"icon-dropbox",chooseTitle:"Dropbox",chooseDescription:"Access password files stored on Dropbox.  Files will be retrieved from Dropbox each time they are used.",interactiveLogin:interactiveLogin,ensureOriginPermissions:ensureOriginPermissions,state:state,login:login,logout:logout};return exports}