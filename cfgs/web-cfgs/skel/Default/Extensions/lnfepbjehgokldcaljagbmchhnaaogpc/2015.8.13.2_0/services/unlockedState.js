/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";function UnlockedState($interval,$location,keepass){function getPassword(entry){return entry.protectedData&&entry.protectedData.password?keepass.getDecryptedEntry(entry.protectedData.password,my.streamKey):entry.password}function parseUrl(url){var parser=document.createElement("a");return parser.href=url,parser}var copyEntry,my={tabId:"",url:"",title:"",origin:"",sitePermission:!1,entries:null,streamKey:null,clipboardStatus:""};my.getTabDetails=function(){return new Promise(function(resolve,reject){chrome.tabs.query({active:!0,currentWindow:!0},function(tabs){if(tabs&&tabs.length){my.tabId=tabs[0].id;var url=tabs[0].url.split("?");my.url=url[0],my.title=tabs[0].title;var parsedUrl=parseUrl(tabs[0].url);my.origin=parsedUrl.protocol+"//"+parsedUrl.hostname+"/",chrome.p.permissions.contains({origins:[my.origin]}).then(function(){my.sitePermission=!0})["catch"](function(){my.sitePermission=!1}).then(function(){resolve()})}else reject(new Error("Unable to determine tab details"))})})},my.clearBackgroundState=function(){my.entries=null,my.streamKey=null,my.clipboardStatus=""},my.autofill=function(entry){chrome.runtime.sendMessage({m:"requestPermission",perms:{origins:[my.origin]},then:{m:"autofill",tabId:my.tabId,u:entry.userName,p:getPassword(entry),o:my.origin}}),window.close()},my.copyPassword=function(entry){copyEntry=entry,entry.copied=!0,document.execCommand("copy")},my.gotoDetails=function(entry){$location.path("/entry-details/"+entry.id)},my.getDecryptedAttribute=function(protectedAttr){return keepass.getDecryptedEntry(protectedAttr,my.streamKey)};var timerInstance;return document.addEventListener("copy",function(e){if(copyEntry){var textToPutOnClipboard=getPassword(copyEntry);copyEntry=null,e.clipboardData.setData("text/plain",textToPutOnClipboard),e.preventDefault(),chrome.alarms.clear("clearClipboard",function(){chrome.alarms.create("clearClipboard",{delayInMinutes:1})}),my.clipboardStatus="Copied to clipboard.  Clipboard will clear in 60 seconds.";var seconds=60;timerInstance&&$interval.cancel(timerInstance),timerInstance=$interval(function(){seconds-=1,0>=seconds?(my.clipboardStatus="Clipboard cleared",$interval.cancel(timerInstance)):my.clipboardStatus="Copied to clipboard.  Clipboard will clear in "+seconds+" seconds."},1e3)}}),my}