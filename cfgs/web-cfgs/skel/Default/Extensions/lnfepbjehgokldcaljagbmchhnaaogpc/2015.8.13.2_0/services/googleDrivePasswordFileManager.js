/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
function GoogleDrivePasswordFileManager($http,$timeout){"use strict";function interactiveRequestAuth(){return auth(!0)}function revokeAuth(){if(accessToken){var url="https://accounts.google.com/o/oauth2/revoke?token="+accessToken;return $http.get(url,{responseType:"jsonp"}).then(function(){return removeCachedAuthToken()})}return Promise.resolve()}function removeCachedAuthToken(){return new Promise(function(resolve){if(accessToken){var tempAccessToken=accessToken;accessToken=null,chrome.identity.removeCachedAuthToken({token:tempAccessToken},function(){resolve()})}else resolve()})}function isAuthorized(){return accessToken?!0:!1}function ensureGoogleUrlPermissions(){var origins=["https://www.googleapis.com/","https://accounts.google.com/","https://*.googleusercontent.com/"];return new Promise(function(resolve,reject){chrome.permissions.contains({origins:origins},function(alreadyGranted){alreadyGranted?resolve():chrome.permissions.request({origins:origins},function(granted){if(granted)resolve();else{var err=chrome.runtime.lastError;console.log(err),reject(new Error("User denied access to google docs urls"))}})})})}function listDatabases(){return getPasswordFiles(!0)["catch"](function(){return[]})}function getPasswordFiles(){var url="https://www.googleapis.com/drive/v2/files?q=(fileExtension='kdbx' or fileExtension='kdb') and trashed=false";return sendAuthorizedGoogleDriveGet(url).then(function(data){return data.items.map(function(entry){return{title:entry.title,url:entry.selfLink}})})}function getDatabaseChoiceData(dbInfo){return{title:dbInfo.title,url:dbInfo.url}}function getChosenDatabaseFile(databaseChoiceData,attempt){return sendAuthorizedGoogleDriveGet(databaseChoiceData.url).then(function(details){return sendAuthorizedGoogleDriveGet(details.downloadUrl,"arraybuffer")}).then(function(data){return data})["catch"](function(err){if(attempt=attempt||0,0==attempt)return getChosenDatabaseFile(databaseChoiceData,1);throw err})}function sendAuthorizedGoogleDriveGet(url,optionalResponseType,attempt){attempt=attempt||0;var rateLimits=[1,2,4,8,16];return auth().then(function(){var request={method:"GET",url:url,headers:{Authorization:"Bearer "+accessToken}};return optionalResponseType&&(request.responseType=optionalResponseType),$http(request)}).then(function(response){return response.data})["catch"](function(response){if(401==response.status&&2>attempt)return removeCachedAuthToken().then(function(){return sendAuthorizedGoogleDriveGet(url,optionalResponseType,attempt+1)});if(403==response.status&&attempt<rateLimits.length){var message="arraybuffer"==optionalResponseType?new Uint8Array(response.data):response.data;return console.log("403, retrying",url,response.statusText,message),$timeout(function(){return sendAuthorizedGoogleDriveGet(url,optionalResponseType,attempt+1)},rateLimits[attempt]+Math.floor(1e3*Math.random()))}throw console.log("failed to fetch",url,accessToken,response),new Error("Request to retrieve files from drive failed - "+(response.statusText||response.message))})}function auth(interactive){return interactive=!!interactive,new Promise(function(resolve,reject){accessToken=null,chrome.identity.getAuthToken({interactive:interactive},function(token){if(accessToken=token,token)resolve();else var err=chrome.runtime.lastError;err||(err=new Error("Failed to authenticate.")),reject("OAuth2 not granted or revoked."==err.message?new Error("CKP needs access to Google Drive to access this password file.  You must Authorize google drive access to continue."):err)})})}var accessToken,exports={key:"gdrive",routePath:"/choose-file",listDatabases:listDatabases,getDatabaseChoiceData:getDatabaseChoiceData,getChosenDatabaseFile:getChosenDatabaseFile,supportedFeatures:["listDatabases"],title:"Google Drive",icon:"icon-google",chooseTitle:"Google Drive",chooseDescription:"Access password files stored on your Google Drive.  The file(s) will be fetched from Google Drive each time they are used.",interactiveRequestAuth:interactiveRequestAuth,revokeAuth:revokeAuth,isAuthorized:isAuthorized,ensureGoogleUrlPermissions:ensureGoogleUrlPermissions};return exports}