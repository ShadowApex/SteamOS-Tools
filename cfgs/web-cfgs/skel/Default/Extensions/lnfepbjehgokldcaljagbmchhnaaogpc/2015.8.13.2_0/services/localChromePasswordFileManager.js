/*! CKP - KeePass integration for Chromeâ„¢, Copyright 2015 Steven Campbell
*/
"use strict";function LocalChromePasswordFileManager(){function listDatabases(){return Promise.all(savingLocks).then(function(){return chrome.p.storage.local.get("passwordFiles")}).then(function(result){var files=result.passwordFiles||[];return files.filter(function(fi){return fi.storageVersion&&fi.storageVersion>=backwardCompatibleVersion})})}function getDatabaseChoiceData(dbInfo){return{title:dbInfo.title}}function getChosenDatabaseFile(dbInfo){return listDatabases().then(function(databases){var bytes=databases.reduce(function(prev,storedFile){if(storedFile.title==dbInfo.title){var data=Base64.decode(storedFile.data);return data}return prev},[]);if(bytes&&bytes.byteLength)return bytes;throw new Error("Failed to find the requested file")})}function saveDatabase(db){db.storageVersion=currentVersion;var p=listDatabases().then(function(existingFiles){var index=existingFiles.reduce(function(prev,curr,index){return curr.title==db.title?index:prev},-1);return-1==index?existingFiles.push(db):existingFiles[index]=db,chrome.p.storage.local.set({passwordFiles:existingFiles})});return savingLocks.push(p),p}function deleteDatabase(db){return listDatabases().then(function(databases){return databases=databases.filter(function(existing){return existing.title!=db.title}),databases.length?chrome.p.storage.local.set({passwordFiles:databases}):chrome.p.storage.local.remove("passwordFiles")})}var exports={key:"local",routePath:"/drag-drop-file",listDatabases:listDatabases,getDatabaseChoiceData:getDatabaseChoiceData,getChosenDatabaseFile:getChosenDatabaseFile,saveDatabase:saveDatabase,deleteDatabase:deleteDatabase,supportedFeatures:["ingognito","listDatabases","saveDatabase","deleteDatabase"],title:"Chrome Storage",icon:"icon-upload",chooseTitle:"File System",chooseDescription:"Upload files from your local or remote file-system.  A one-time copy of the file(s) will be saved in Chrome local storage.  If you update the database on your local system then you will have to re-upload it in order to see the changes."},backwardCompatibleVersion=1,currentVersion=1,savingLocks=[];return exports}